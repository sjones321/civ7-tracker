<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>Independent Peoples — S3 Fix</title>
<style>
  :root{ --bg:#0f1216; --panel:#171b21; --text:#e6edf3; --muted:#9aa4b2; --border:#242a33; --accent:#4aa3ff; }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial}
  .wrap{max-width:1100px;margin:0 auto;padding:16px}
  .card{background:var(--panel);border:1px solid var(--border);border-radius:12px;padding:14px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  input,select{background:#0b0f14;border:1px solid var(--border);border-radius:10px;color:#e6edf3;padding:8px 10px}
  .btn{background:var(--accent);color:#001329;border:none;border-radius:10px;padding:8px 12px;font-weight:700;cursor:pointer}
  .btn.small{padding:4px 8px;font-size:12px;border-radius:8px}
  .small{font-size:12px;color:var(--muted)}

  /* Ideology colors (match Data Editor) */
  .ide-label{font-weight:800}
  .ide-Culture { color:#d8c8ff; }
  .ide-Diplomatic { color:#bcd4ff; }
  .ide-Economic { color:#ffe8b8; }
  .ide-Expansionist { color:#c9ffd9; }
  .ide-Military { color:#ffd1d1; }
  .ide-Scientific { color:#d1e7ff; }

  /* Hostile spacing at the source */
  label.small:has(#hostile){display:inline-flex;align-items:center;gap:6px}
  #hostile{margin:0}

  /* Sections & items */
  .sections{display:grid;gap:16px;margin-top:12px}
  .section{background:#171b21;border:1px solid #242a33;border-radius:12px;padding:12px}
  .section .head{display:flex;align-items:center;justify-content:space-between;gap:10px}
  .list{display:grid;gap:8px}
  .item{display:flex;align-items:center;justify-content:space-between;gap:10px;border:1px solid #242a33;border-radius:10px;padding:8px 10px;background:#0b0f14}
  .badge{padding:2px 6px;border-radius:999px;border:1px solid #242a33;font-size:11px}
  .badge.hostile{background:#3b1111;border-color:#803d3d;color:#ffb4b4}
  .badge.region{background:#10201a;border-color:#1d3a2e;color:#b8ffd2}

  /* Typeahead */
  .typeahead{position:relative;display:inline-block;min-width:220px}
  .typeahead-list{position:absolute;top:100%;left:0;right:0;background:#0b0f14;border:1px solid var(--border);border-top:none;max-height:220px;overflow:auto;z-index:20;border-radius:0 0 10px 10px;display:none}
  .typeahead-item{padding:8px 10px;cursor:pointer}
  .typeahead-item:hover{background:#11161f}
  .typeahead-empty{padding:8px 10px;color:#6b7483}
</style>
</head>
<body>
  <div id="topbar-root"></div>
  <main class="wrap">
    <h1>Independent Peoples</h1>

    <!-- Add / Update City -->
    <section class="card">
      <h2>Add / Update City</h2>
      <div class="row" style="margin-top:6px">
        <label class="small" for="cityName">City</label>
        <span class="typeahead">
          <input id="cityName" placeholder="Type a city name" autocomplete="off">
          <div id="cityTA" class="typeahead-list"></div>
        </span>
        <label class="small" for="ideo">Ideology</label>
        <select id="ideo">
          <option class="ide-Culture">Culture</option>
          <option class="ide-Diplomatic">Diplomatic</option>
          <option class="ide-Economic">Economic</option>
          <option class="ide-Expansionist">Expansionist</option>
          <option class="ide-Military">Military</option>
          <option class="ide-Scientific">Scientific</option>
        </select>
        <label class="small" for="region">Region</label>
        <select id="region"><option>Homelands</option><option>Distant Lands</option></select>
        <label class="small" for="age">Discovered Age</label>
        <select id="age"><option>Antiquity</option><option>Exploration</option><option>Modern</option></select>
        <label class="small"><input type="checkbox" id="hostile"> Hostile</label>
        <button class="btn" id="saveCity">Save</button>
      </div>
    </section>

    <!-- Sections -->
    <section class="sections" id="sections"></section>
  </main>

  <script src="auth.js"></script>
  <script src="require-auth.js"></script>
  <script src="common.store.js"></script>
  <script src="topbar.js"></script>

  <script>
  (function(){
    const IDEOS = ["Culture","Diplomatic","Economic","Expansionist","Military","Scientific"];
    const LS_KEY = "civ7_data_store_v3";
    function el(id){ return document.getElementById(id); }
    function getS(){
      try { return Store.get(); }
      catch(e){
        try { return JSON.parse(localStorage.getItem(LS_KEY))||{}; } catch(_){ return {state:{current:{}}}; }
      }
    }
    function saveS(mut){
      Store.update(s=>{
        s.state=s.state||{}; s.state.current=s.state.current||{};
        s.state.current.ipGame=s.state.current.ipGame||[];
        s.editor=s.editor||{}; s.editor.data=s.editor.data||{};
        if(!Array.isArray(s.editor.data.cityStates)) s.editor.data.cityStates=[];
        mut(s);
      });
    }

    function gatherNames(){
      const s = getS(); const names = new Set();
      (s.state?.current?.ipGame||[]).forEach(c=>{ if(c?.name) names.add(c.name); });
      Object.values(s.ipStats||{}).forEach(v=>{ if(v?.name) names.add(v.name); });
      (s.editor?.data?.cityStates||[]).forEach(cs=>{ if(cs?.name) names.add(cs.name); });
      return Array.from(names).sort((a,b)=> a.localeCompare(b));
    }

    // Typeahead
    function wireTypeahead(){
      const input = el('cityName'); const list = el('cityTA'); if(!input||!list) return;
      let all = gatherNames();
      function close(){ list.style.display='none'; }
      function open(){ list.style.display='block'; }
      function render(filter){
        list.innerHTML=''; const q=(filter||'').trim().toLowerCase();
        let hits = all; if(q) hits = all.filter(n => n.toLowerCase().includes(q));
        hits = hits.slice(0,80);
        if(hits.length===0){ const div=document.createElement('div'); div.className='typeahead-empty'; div.textContent='No matches'; list.appendChild(div); }
        else { hits.forEach(name=>{ const item=document.createElement('div'); item.className='typeahead-item'; item.textContent=name; item.addEventListener('mousedown', e=>{ e.preventDefault(); input.value=name; close(); }); list.appendChild(item); }); }
      }
      input.addEventListener('focus', ()=>{ all=gatherNames(); render(input.value); open(); });
      input.addEventListener('input', ()=>{ all=gatherNames(); render(input.value); open(); });
      input.addEventListener('blur', ()=>{ setTimeout(close, 100); });
    }

    function renderSections(){
      const host = el('sections'); host.innerHTML = '';
      const s = getS();
      const list = (s.state?.current?.ipGame)||[];
      const groups = {}; IDEOS.forEach(k=> groups[k]=[]);
      list.forEach((c, idx)=>{ if(c && c.ideology){ (groups[c.ideology]||(groups[c.ideology]=[])).push({c, idx}); } });

      // Always render headers
      IDEOS.forEach(ideo=>{
        const sec = document.createElement('section'); sec.className='section';
        sec.innerHTML = `<div class="head"><h2><span class="ide-label ide-${ideo}">${ideo}</span></h2></div><div class="list" id="list-${ideo}"></div>`;
        host.appendChild(sec);
        const container = el('list-'+ideo);
        (groups[ideo]||[]).sort((A,B)=> (A.c.name||"").localeCompare(B.c.name||"")).forEach(({c, idx})=>{
          const div = document.createElement('div'); div.className='item';
          div.innerHTML = `
            <div>
              <div style="font-weight:800">${c.name||"(unnamed)"} ${c.hostile?'<span class="badge hostile">Hostile</span>':''}</div>
              <div class="small">Age: ${c.age||"—"} • Region: <span class="badge region">${c.region||"—"}</span></div>
            </div>
            <div><button class="btn small" data-remove>Remove</button></div>
          `;
          div.querySelector('[data-remove]').onclick = function(){
            saveS(s=>{ const arr=s.state.current.ipGame; if(idx>=0 && idx<arr.length) arr.splice(idx,1); });
            setTimeout(renderSections, 0);
          };
          container.appendChild(div);
        });
      });
    }

    function onLoad(){
      renderSections(); wireTypeahead();
      const btn = el('saveCity');
      if(btn){
        btn.onclick = function(){
          const name=(el('cityName').value||'').trim(); if(!name){alert('City name is required.'); return;}
          const ideology=el('ideo').value, region=el('region').value, age=el('age').value, hostile=!!el('hostile').checked;
          saveS(s=>{
            const arr=s.state.current.ipGame;
            const i=arr.findIndex(x=> x && x.name && x.name.toLowerCase()===name.toLowerCase());
            const obj={name,ideology,region,age,hostile,owner:(arr[i]?.owner||"")};
            if(i>=0) arr[i]=obj; else arr.push(obj);

            // Mirror into Data Editor list so editor <-> IP stay in sync
            const list=Array.isArray(s.editor.data.cityStates)?s.editor.data.cityStates:(s.editor.data.cityStates=[]);
            const j=list.findIndex(cs=> cs && cs.name && cs.name.toLowerCase()===name.toLowerCase());
            const base={name,notes:"",appearedByAge:{Antiquity:0,Exploration:0,Modern:0},appearedByType:{Military:0,Economic:0,Culture:0,Diplomatic:0,Scientific:0,Expansionist:0},homeCount:0,distantCount:0,hostileCount:0,lastSeen:""};
            const t=(j>=0?list[j]:base);
            if (t.appearedByAge[age]!=null) t.appearedByAge[age]=(t.appearedByAge[age]||0)+1;
            if (t.appearedByType[ideology]!=null) t.appearedByType[ideology]=(t.appearedByType[ideology]||0)+1;
            if (region==="Homelands") t.homeCount=(t.homeCount||0)+1;
            if (region==="Distant Lands") t.distantCount=(t.distantCount||0)+1;
            if (hostile) t.hostileCount=(t.hostileCount||0)+1;
            t.lastSeen=new Date().toISOString();
            if(j>=0) list[j]=t; else list.push(t);
          });
          el('cityName').value=''; el('hostile').checked=false;
          setTimeout(()=>{ renderSections(); wireTypeahead(); }, 0);
        };
      }

      if(window.Store && Store.subscribe){
        Store.subscribe(()=>{ renderSections(); wireTypeahead(); });
      }
    }

    window.addEventListener('DOMContentLoaded', onLoad);
  })();
  </script>
</body>
</html>
