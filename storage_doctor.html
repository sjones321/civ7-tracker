<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Civ7 Tracker – Storage Doctor</title>
<meta name="viewport" content="width=device-width,initial-scale=1">
<style>
  :root{
    --bg:#0b1220; --card:#121a2b; --border:#25314a; --txt:#e7eefc; --muted:#9bb0d1;
    --accent:#f2880f; --tiny:#001a07;
  }
  body{background:var(--bg);color:var(--txt);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;margin:0;padding:24px;}
  h1{margin:0 0 16px 0;font-size:22px;}
  .row{display:flex;gap:16px;flex-wrap:wrap}
  .card{background:var(--card);border:1px solid var(--border);border-radius:12px;padding:16px;min-width:300px;flex:1}
  .k{font-family:ui-monospace,Consolas,monospace;color:#b3c6ff}
  pre{white-space:pre-wrap;word-break:break-word;background:#0d1425;border:1px dashed var(--border);padding:12px;border-radius:10px;max-height:280px;overflow:auto}
  button{background:#1b2742;border:1px solid var(--border);color:var(--txt);padding:8px 12px;border-radius:8px;cursor:pointer}
  button.danger{background:#3a1020;border-color:#6b1f3f}
  button.good{background:#0f2f1c;border-color:#215a3b}
  .tiny{color:#89a; font-size:12px}
</style>
</head>
<body>
  <h1>Civ7 Tracker – Storage Doctor</h1>
  <p class="tiny">Use this to inspect, migrate, or clear localStorage used by the site.</p>

  <div class="row">
    <div class="card">
      <h3>Keys observed</h3>
      <ul id="keys"></ul>
      <button id="refresh">Refresh</button>
    </div>

    <div class="card">
      <h3>Inspect a key</h3>
      <div>
        <label class="tiny">Key name</label><br>
        <input id="keyName" style="width:100%;padding:8px;border-radius:8px;border:1px solid var(--border);background:#0d1425;color:var(--txt)"
               placeholder="e.g., c7_store or civ7_data_store_v3 or civ7_home_state_v3">
      </div>
      <div style="margin-top:10px;display:flex;gap:8px;flex-wrap:wrap">
        <button id="read">Read</button>
        <button id="clear" class="danger">Clear</button>
      </div>
      <pre id="dump">(no data)</pre>
    </div>

    <div class="card">
      <h3>Migrate / Fix</h3>
      <p class="tiny">One-click helpers:</p>
      <div style="display:flex;flex-direction:column;gap:8px">
        <button id="wipeAll" class="danger">Wipe ALL known keys</button>
        <button id="copyEditorToLists" class="good">Copy <span class="k">c7_store.editor.data</span> → <span class="k">civ7_data_store_v3</span> lists</button>
        <button id="copyEditorSelectionsToHome" class="good">Copy current selections in <span class="k">c7_store.current.players</span> → <span class="k">civ7_home_state_v3</span></button>
        <button id="promoteHomeToWindow" class="good">Reload page with <span class="k">window.state</span> hydrated from <span class="k">civ7_home_state_v3</span></button>
      </div>
    </div>
  </div>

<script>
(function(){
  const $ = s=>document.querySelector(s);
  const $$ = s=>Array.from(document.querySelectorAll(s));

  const K_EDITOR_PREF = "c7_store";                // Editor writes here
  const K_LISTS       = "civ7_data_store_v3";      // Lists/icons used by site
  const K_HOME        = "civ7_home_state_v3";      // Home page game state

  function safeParse(raw){ try{ return raw? JSON.parse(raw):{} }catch(e){ return {} } }
  function readKey(k){ return localStorage.getItem(k); }
  function writeKey(k,v){ localStorage.setItem(k, v); }
  function removeKey(k){ localStorage.removeItem(k); }

  function listKeys(){
    const ks = [];
    for (let i=0;i<localStorage.length;i++){ ks.push(localStorage.key(i)); }
    ks.sort();
    $("#keys").innerHTML = ks.map(k=>`<li><span class="k">${k}</span></li>`).join("") || "<li>(localStorage empty)</li>";
  }

  function readPretty(k){
    const raw = readKey(k);
    if (!raw) { $("#dump").textContent = "(null / not set)"; return; }
    try { $("#dump").textContent = JSON.stringify(JSON.parse(raw), null, 2); }
    catch(e){ $("#dump").textContent = raw; }
  }

  function copyEditorToLists(){
    const pref = safeParse(readKey(K_EDITOR_PREF));
    const out = safeParse(readKey(K_LISTS));

    // Merge leaders array (Editor uses editor.data.leaders)
    const leaders = Array.isArray(pref?.editor?.data?.leaders) ? pref.editor.data.leaders.map(o=>({name:o.name, desc:o.description||o.desc||"", image:o.image||""})) : [];
    if (!out.leaders) out.leaders = [];
    leaders.forEach(L=>{
      if (!out.leaders.find(x=>x.name===L.name)) out.leaders.push(L);
    });

    // Merge mementos
    const mems = Array.isArray(pref?.editor?.data?.mementos) ? pref.editor.data.mementos : [];
    if (!out.mementos) out.mementos = [];
    mems.forEach(m=>{
      if (!out.mementos.find(x=>x.name===m.name)) out.mementos.push({name:m.name, effect:m.effect||m.description||"", image:m.image||m.icon||""});
    });

    // Merge civs map + meta
    const civs = Array.isArray(pref?.editor?.data?.civs) ? pref.editor.data.civs : [];
    out.civs = out.civs || {Antiquity:[],Exploration:[],Modern:[]};
    out.civMeta = out.civMeta || {};
    civs.forEach(c=>{
      const name = c.name||c.title||"";
      const ages = Array.isArray(c.ages) ? c.ages : (typeof c.age==="string"? [c.age] : ["Antiquity"]);
      ages.forEach(a=>{
        if (out.civs[a] && name && !out.civs[a].includes(name)) out.civs[a].push(name);
      });
      if (name){
        out.civMeta[name] = out.civMeta[name] || {};
        if (c.description && !out.civMeta[name].desc) out.civMeta[name].desc = c.description;
      }
    });

    // Icons are left as-is
    writeKey(K_LISTS, JSON.stringify(out));
    alert("Copied editor data → civ7_data_store_v3 lists.");
  }

  function copyEditorSelectionsToHome(){
    const pref = safeParse(readKey(K_EDITOR_PREF));
    const cur = pref?.current?.players || { steve:{leaders:[],mementos:[],civs:[]}, tiny:{leaders:[],mementos:[],civs:[]} };
    const home = safeParse(readKey(K_HOME)) || {};
    home.current = home.current || { players:{ steve:{leaders:[],mementos:[],civs:[]}, tiny:{leaders:[],mementos:[],civs:[]} } };
    home.current.players.steve = cur.steve || {leaders:[],mementos:[],civs:[]};
    home.current.players.tiny  = cur.tiny  || {leaders:[],mementos:[],civs:[]};
    writeKey(K_HOME, JSON.stringify(home));
    alert("Copied current selections → civ7_home_state_v3.");
  }

  function wipeAll(){
    if (!confirm("Wipe ALL known keys? This clears editor lists and home game state.")) return;
    if (!confirm("Are you sure? This cannot be undone.")) return;
    removeKey(K_EDITOR_PREF);
    removeKey(K_LISTS);
    removeKey(K_HOME);
    listKeys();
    $("#dump").textContent = "(no data)";
    alert("All known keys cleared.");
  }

  function promoteHomeToWindow(){
    // Just a helper: creates a tiny script in sessionStorage for your index.html to load state on next reload
    const home = readKey(K_HOME);
    if (!home){ alert("No civ7_home_state_v3 found to hydrate."); return; }
    sessionStorage.setItem("__c7_promote_home__", "1");
    alert("Reload your HOME page now. It will hydrate window.state from civ7_home_state_v3 for this session.");
  }

  // hooks
  $("#refresh").onclick = listKeys;
  $("#read").onclick = ()=> readPretty($("#keyName").value.trim());
  $("#clear").onclick = ()=>{
    const k = $("#keyName").value.trim();
    if (!k) return;
    if (!confirm(`Clear localStorage key "${k}"?`)) return;
    localStorage.removeItem(k);
    readPretty(k);
    listKeys();
  };
  $("#copyEditorToLists").onclick = copyEditorToLists;
  $("#copyEditorSelectionsToHome").onclick = copyEditorSelectionsToHome;
  $("#wipeAll").onclick = wipeAll;
  $("#promoteHomeToWindow").onclick = promoteHomeToWindow;

  listKeys();
})();
</script>
</body>
</html>
