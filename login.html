<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>Civilization 7 Tracker â€” Sign in</title>
<style>
:root{ --bg:#0f1216; --panel:#171b21; --text:#e6edf3; --muted:#9aa4b2; --border:#242a33; --accent:#4aa3ff; }
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font-family:ui-sans-serif,system-ui,-apple-system,"Segoe UI",Roboto,Arial}
.wrap{max-width:520px;margin:8vh auto;padding:16px}
.card{background:#171b21;border:1px solid var(--border);border-radius:14px;padding:18px}
h1{margin:0 0 12px 0;font-size:22px}
.row{display:flex;gap:10px;align-items:center;margin:10px 0;flex-wrap:wrap}
label{font-size:13px}
input,select{width:100%;padding:10px;border-radius:10px;border:1px solid #2b3447;background:#0f1520;color:#e6edf3}
.btn{width:100%;padding:12px;border:none;border-radius:10px;background:var(--accent);color:#fff;font-weight:800;cursor:pointer;margin-top:10px}
.note{color:var(--muted);font-size:13px}
</style>
</head>
<body>
<div class="wrap">
  <div class="card">
    <h1>Sign in</h1>
    <div class="row">
      <label for="name">Player</label>
      <select id="name">
        <option value="Steve">Steve</option>
        <option value="Tiny">Tiny</option>
        <option value="Guest">Guest (read-only)</option>
      </select>
    </div>
    <div class="row" id="pwdRow">
      <label for="pw">Password</label>
      <input id="pw" type="password" placeholder="Password" autocomplete="current-password"/>
      <div class="note">Hint: shared password is <code>friends</code> (Guest doesn't need one).</div>
    </div>
    <button id="go" class="btn" type="button">Login</button>
  </div>
</div>

<script src="auth.js"></script>
<script>
(function(){
  // Defensive: block Enter auto-submit/page-refresh by capturing on the document.
  document.addEventListener('submit', function(e){ e.preventDefault(); }, true);

  var nameEl = document.getElementById('name');
  var pwEl   = document.getElementById('pw');
  var goBtn  = document.getElementById('go');
  var pwdRow = document.getElementById('pwdRow');

  function updatePwdRow(){
    pwdRow.style.display = (nameEl.value === 'Guest') ? 'none' : 'block';
  }
  nameEl.addEventListener('change', updatePwdRow);
  updatePwdRow();

  function ready(){ return (window.civ7auth && typeof civ7auth.setUser==='function'); }

  function submitLogin(ev){
    if (ev) ev.preventDefault();
    if (!ready()){ alert("Auth not loaded yet. Please try again."); return; }
    var name = nameEl.value;
    if (name !== 'Guest'){
      var pwd = (pwEl.value||"").trim();
      if (!pwd){ alert("Enter password."); return; }
      if (pwd !== 'friends'){ alert("Incorrect password."); pwEl.value=""; pwEl.focus(); return; }
      civ7auth.setUser({ name, readonly:false, loggedInAt: Date.now() });
      civ7auth.logAudit && civ7auth.logAudit({ action:'login', role:'player' });
    }else{
      civ7auth.setUser({ name:'Guest', readonly:true, loggedInAt: Date.now() });
      civ7auth.logAudit && civ7auth.logAudit({ action:'login', role:'guest' });
    }
    location.replace('index.html');
  }

  goBtn.addEventListener('click', submitLogin);
  // Enter-to-submit support, but prevent default page reload
  document.addEventListener('keydown', function(e){
    if (e.key === 'Enter'){ e.preventDefault(); submitLogin(e); }
  });
})();
</script>
</body>
</html>
